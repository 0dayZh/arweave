<html>
    <head>
        <title>
            Internet Archive Decentralised Torrent Index
        </title>
        <!-- Download WebTorrent.js from the Arweave -->
        <script src="/tx/SDZnef9VSR4B0iz8xmo3qkt672WtdlhP4KUjcgjCQTU/data.html"></script>
        <script>
            // If debugging, use a known Arweave node.
            // For production, use an empty string.
            var node = "";
            var client = new WebTorrent();
            var byte_count = 0;

            function getTorrentInfo(id, cell) {
                var torrent_url = node + "/tx/" + id +"/data.torrent";
                var link = document.createElement("a");
                link.innerHTML = "Download files";
                link.href = torrent_url;
                cell.appendChild(link);
                var br = document.createElement("br");
                cell.appendChild(br);

                client.add(torrent_url, function (t) {
                    var bytes = 0;
                    for(j = 0; j < t.files.length; j++) {
                        var file = t.files[j];
                        var div = document.createElement("div");
                        div.innerText = file.name;
                        cell.appendChild(div);
                        bytes += file.length;
                    }
                    var size_div = document.createElement("div");
                    size_div.innerHTML = "<b>Total size: </b> " + bytes.toString() + " bytes";
                    cell.appendChild(size_div);
                });
            }

            function addItem(id) {
                var cont = document.createElement("tr");
                var tx_req = new XMLHttpRequest();
                tx_req.open("GET", node + "/tx/" + id + "/tags");

                tx_req.onload = function(ev) {
                    if(tx_req.status == 200) {
                        // Print details
                        var tags = JSON.parse(tx_req.responseText);
                        var td = document.createElement("td");
                        var item_name = document.createElement("div");
                        var item_tags = document.createElement("div");
                        item_tags.className = "tags";
                        td.appendChild(item_name);
                        td.appendChild(item_tags);
                        cont.appendChild(td);

                        tags.map(function(tag) {
                            if(atob(tag.name) == "title") {
                                item_name.innerHTML = "<b>" + atob(tag.value) + "</b>";
                                cont.title = atob(tag.value);
                            }
                        });
                        var get_info_cell = document.createElement("td");
                        var torrent_button = document.createElement("button");
                        torrent_button.innerHTML = "Get Info";
                        torrent_button.onclick =
                            function() {
                                torrent_button.style.display = 'none';
                                getTorrentInfo(id, item_tags);
                            };
                        get_info_cell.appendChild(torrent_button);
                        cont.appendChild(get_info_cell);
                        var index = document.getElementById("index");
                        index.appendChild(cont);
                    }
                }

                tx_req.send();
            }

            function search() {
                var index = document.getElementById("index");
                var rows = index.children;
                var search = document.getElementById("search").value;
                search = search.toUpperCase();

                for(i = 0; i < rows.length; i++) {
                    var row = rows[i];
                    var title = row.getAttribute("title");
                    title = title.toUpperCase();

                    if((search == "") || (title.search(search) != -1)) {
                        row.style.display = '';
                    }
                    else {
                        row.style.display = 'none';
                    }
                }
            }

            var req = new XMLHttpRequest();
            req.open("POST", node + "/arql", true);

            req.onload = function(e) {
                if(req.status == 200) {
                    var txs = eval(req.responseText);

                    txs.map(function(tx) {
                        addItem(tx);
                    });
                }
            }

            req.send('{"op": "equals", "expr1": "app_name", "expr2": "InternetArchive"}');
        </script>
        <style>
            tr {
                margin-bottom: 2em;
            }

            .tags {
                font-size: 0.8em;
            }
        </style>
    </head>
    <body>
        <h1>Internet Archive Decentralised Torrent Index</h1>
        <h2>Universal access to information</h2>
        <p>This is an index of torrent files relating to data stored on the 
            Internet Archive. It is possible to access the page you are viewing
            in an entirely decentralised manner using the Arweave web extension.
        </p>
        <p>
            The archived torrents and their metadata should show below shortly:
        </p>
        <div>
            <table>
                <thead>
                    <tr class="heading">
                        <td colspan="2">
                            Arweave Decentralised Internet Archive Portal
                        </td>
                    </tr>
                    <tr>
                        <td>Name</td>
                        <td>Torrent</td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <input
                                id="search"
                                placeholder="Filter torrents..."
                                oninput="search()" />
                        </td>
                    </tr>
                </thead>
                <tbody id="index">

                </tbody>
            </table>
        </div>
    </body>
</html>